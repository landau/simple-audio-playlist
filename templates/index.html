<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <meta name="description" content="">
  <meta name="author" content="Trevor Landau">
  <!-- <link rel="icon" href="../../favicon.ico"> -->

  <title>Easy Audio</title>

  <!-- Bootstrap core CSS -->
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

  <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
  <!-- <link href="../../assets/css/ie10-viewport-bug-workaround.css" rel="stylesheet"> -->

  <!-- Custom styles for this template -->
  <style>
    /* Sticky footer styles
    -------------------------------------------------- */
    html {
      position: relative;
      min-height: 100%;
    }
    body {
      /* Margin bottom by footer height */
      margin-bottom: 60px;
    }
    .footer {
      position: absolute;
      bottom: 0;
      width: 100%;
      /* Set the fixed height of the footer here */
      height: 60px;
      background-color: #f5f5f5;
    }

    /* Custom page CSS
    -------------------------------------------------- */
    /* Not required for template or sticky footer method. */

    body > .container, body > .container-fluid {
      padding: 60px 15px 0;
    }
    .container .text-muted, .container-fluid .text-muted {
      margin: 20px 0;
    }

    .footer > .container, .footer > .container-fluid {
      padding-right: 15px;
      padding-left: 15px;
    }

    code {
      font-size: 80%;
    }

    .glyphicon {
      font-size: 40px;
    }
  </style>

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>

<body>

  <!-- Fixed navbar -->
  <!-- <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="#">Project name</a>
      </div>

      <div id="navbar" class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li class="active"><a href="#">Home</a></li>
          <li><a href="#about">About</a></li>
          <li><a href="#contact">Contact</a></li>
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Dropdown <span class="caret"></span></a>
            <ul class="dropdown-menu">
              <li><a href="#">Action</a></li>
              <li><a href="#">Another action</a></li>
              <li><a href="#">Something else here</a></li>
              <li role="separator" class="divider"></li>
              <li class="dropdown-header">Nav header</li>
              <li><a href="#">Separated link</a></li>
              <li><a href="#">One more separated link</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav> -->

  <!-- Begin page content -->
  <div class="container-fluid">
    <!-- <div class="media" data-track data-src="Chamomile.mp3">
      <div class="media-left">
        <a href="#">
          <span class="glyphicon glyphicon-play" aria-hidden="true" data-button></span>
        </a>
      </div>
      <div class="media-body">
        <h4 class="media-heading" data-name>{trackName}</h4>
        <div class="progress">
          <div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 100%;" data-progress>
            0:00
          </div>
        </div>
      </div>
    </div> -->
    {items}
  </div>

  <!-- <footer class="footer">
    <div class="container">
      <p class="text-muted"></p>
    </div>
  </footer> -->

  <!-- <script src="index.js"></script> -->
  <script>
  (() => {
    'use strict';

    const BUTTON_PLAY_CLASS = 'glyphicon-play';
    const BUTTON_PAUSE_CLASS = 'glyphicon-pause';

    class Track {
      constructor(element) {
        this.element = element;

        this.button = element.querySelector('[data-button]');
        if (!this.button) {
          throw new Error('Unable to find button.');
        }


        this.progress = element.querySelector('[data-progress]');
        if (!this.progress) {
          throw new Error('Unable to find progress bar.');
        }

        this.name = element.querySelector('[data-name]');
        if (!this.name) {
          throw new Error('Unable to find name element.');
        }

        this.isPlaying = false;
        this.src = element.dataset.src;
        this.name.innerHTML = this.src

        console.log(`Track with src ${this.src} created.`);

        this.onClickEvents = [];

        this.element.addEventListener('click', e => {
          console.log(`Track with src ${this.src} clicked.`);
          this.onClickEvents.forEach(fn => fn(this));
        });
      }

      play() {
        this.button.classList.remove(BUTTON_PLAY_CLASS);
        this.button.classList.add(BUTTON_PAUSE_CLASS);
      }

      stop() {
        this.button.classList.remove(BUTTON_PAUSE_CLASS);
        this.button.classList.add(BUTTON_PLAY_CLASS);
      }

      onClick(fn) {
        this.onClickEvents.push(fn);
      }

      setTime(duration, currentTime) {
        const rem = parseInt(duration - currentTime, 10);
        const mins = Math.floor(rem / 60, 10);
        let secs = rem - mins * 60;

        if (secs < 10) {
          secs = `0${secs}`;
        }

        // console.log(mins, secs);

        const t = 100 - ((currentTime / duration) * 100);
        this.progress.style.width = `${t}%`;
        this.progress.innerHTML = `${mins}:${secs}`;
      }
    }

    class Player {
      constructor(elements) {
        console.log('Player constructed');

        this.isPlaying = false;
        this.track = null;
        this.audio = new Audio();

        this.tracks = Array.from(elements).map(e => new Track(e));
        this.tracks.forEach(t => {
          t.onClick(t => this.play(t));
        });
      }

      play(track) {

        if (this.isPlaying) {
          this.stop();

          // Same track clicked,
          if (track === this.track) {
            return;
          }
        }

        console.log(`Playing track ${track.src}.`);

        // Keep current location of track if same track is played
        if (track !== this.track) {
          this.audio.src = track.src;
        }

        this.audio.play();
        this.isPlaying = true;

        this.track = track;
        this.track.play();

        this.timer = setInterval(() => {
          track.setTime(this.audio.duration, this.audio.currentTime);
        }, 1e3);

        // TODO: handle loading
        // TODO: handled ended event for calling stop.
        // https://developer.mozilla.org/en-US/docs/Web/API/HTMLMediaElement/ended
      }

      stop() {
        if (this.isPlaying) {
          console.log(`Stopping track ${this.track.src}.`);
          clearInterval(this.timer);

          this.track.stop();
          this.audio.pause();
          this.isPlaying = false;
        }
      }

      // TODO: add step back 15sec
    }
    const p = new Player(document.querySelectorAll('div[data-track]'));
    window.p = p;
  })();
  </script>
</body>
</html>
